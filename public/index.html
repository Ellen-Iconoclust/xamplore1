<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Xamplore – Secure Exam Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Tailwind Importing-->
<script src="https://cdn.tailwindcss.com"></script>

<!-- jsPDF(For PDF Generation after test(Needs testing))-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Lucide for Icons-->
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">

<style>
* { user-select:none; -webkit-user-select:none; }
body { font-family:'Poppins',sans-serif; overflow-x: hidden; }
.brand { font-family:'Montserrat',sans-serif; }
input[type="password"] { user-select: none; -webkit-user-select: none; }
.timer-running { animation: pulse 2s infinite; }
@keyframes pulse {
  0%, 100% { background-color: #fef3c7; }
  50% { background-color: #fde68a; }
}
.exam-closed { background-color: #fee2e2; border-color: #fca5a5; }
.exam-open { background-color: #d1fae5; border-color: #34d399; }
.exam-waiting { background-color: #fef3c7; border-color: #fbbf24; }
</style>
</head>

<body class="bg-white text-gray-800 min-h-screen flex flex-col">

<div id="welcomePopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
    <button onclick="closeWelcomePopup()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
      <i data-lucide="x"></i>
    </button>
    <div class="flex items-center gap-2 mb-4">
      <i data-lucide="graduation-cap" class="text-emerald-600"></i>
      <h3 class="text-xl font-bold text-emerald-600">Welcome to Xamplore!</h3>
    </div>
    <p class="text-gray-600 mb-4">
      Ready to test your knowledge? Head over to the <span class="font-semibold text-emerald-600">Test</span> section to take exams.
    </p>
    <div class="text-sm text-gray-500">
      <i data-lucide="info" class="inline w-4 h-4 mr-1"></i>
      Platform Version: <span class="font-bold">Xam3.0</span>
    </div>
  </div>
</div>
  
<nav class="border-b shadow-sm sticky top-0 bg-white z-40">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-2 brand text-2xl font-extrabold text-emerald-600">
      <i data-lucide="graduation-cap"></i> Xamplore
      <span class="text-xs font-normal bg-emerald-100 text-emerald-700 px-2 py-1 rounded">v3.0</span>
    </div>

    <div class="hidden md:flex gap-8 font-semibold">
      <button onclick="showSection('home')">Home</button>
      <button onclick="showSection('test')">Test</button>
      <button onclick="showSection('hangman')">Hangman</button>
      <button onclick="showSection('admin')">Admin</button>
      <button onclick="showSection('about')">About</button>
    </div>

    <button class="md:hidden" onclick="toggleMenu()">
      <i data-lucide="menu"></i>
    </button>
  </div>

  <div id="mobileMenu" class="hidden md:hidden px-6 pb-4 space-y-3 font-semibold">
    <button onclick="showSection('home')" class="block">Home</button>
    <button onclick="showSection('test')" class="block">Test</button>
    <button onclick="showSection('hangman')" class="block">Hangman</button>
    <button onclick="showSection('admin')" class="block">Admin</button>
    <button onclick="showSection('about')" class="block">About</button>
  </div>
</nav>
<section id="home" class="py-20 text-center">
  <h1 class="text-4xl font-extrabold brand text-emerald-600">
    Smarter Exams
  </h1>
  <p class="mt-3 text-xl font-semibold">Built for SRCAS Students</p>
  <p class="mt-6 max-w-xl mx-auto text-gray-600">
    Xamplore is a secure online examination platform with strict timing controls to prevent cheating.
  </p>
</section>
<section id="test" class="hidden py-16">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-xl">

    <!-- Exam Window Status Display -->
    <div id="examWindowStatus" class="hidden mb-4 p-3 border rounded-lg text-center">
      <div id="examWindowContent">
      </div>
    </div>

    <!-- Global Timer | Added:Xam2.0 -->
    <div id="globalTimerDisplay" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
      <div class="flex items-center justify-center gap-2">
        <i data-lucide="clock" class="text-yellow-600"></i>
        <span class="font-bold text-yellow-700">Exam Window:</span>
        <span id="globalTimer" class="font-mono text-xl font-bold text-yellow-800">--:--</span>
      </div>
      <p id="timerMessage" class="text-xs text-yellow-600 mt-1"></p>
    </div>

    <div id="loader" class="hidden text-center py-10">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-600 mx-auto"></div>
      <p class="mt-3 text-emerald-600 font-semibold">Connecting to Server...</p>
    </div>

    <div id="login">
      <h2 class="text-2xl font-bold mb-4 text-emerald-600">Exam Login</h2>
      
      <div id="completedPatternsWarning" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center gap-2 text-sm text-red-600 mb-2">
          <i data-lucide="alert-circle" class="text-red-600"></i>
          <span class="font-semibold">Completed Patterns:</span>
        </div>
        <div id="completedPatternsList" class="flex flex-wrap gap-2">
          
        </div>
        <p class="text-xs text-red-500 mt-2">You cannot retake completed patterns</p>
      </div>
      
      <input id="nameInput" class="w-full p-2 mb-3 border rounded" placeholder="Your Name">
      <select id="patternSelect" class="w-full p-2 mb-3 border rounded">
        <option value="">Select Pattern</option>
        <option value="A">Pattern A</option>
        <option value="B">Pattern B</option>
        <option value="C">Pattern C</option>
      </select>
      
      <input id="passwordInput" type="password" class="w-full p-2 mb-4 border rounded" placeholder="Pattern Password">
      <button onclick="verifyLogin()" class="w-full bg-emerald-600 text-white p-2 rounded font-semibold">
        Continue
      </button>
      <p id="patternWarning" class="text-red-500 text-xs mt-2 hidden"></p>
    </div>

    <div id="rules" class="hidden">
      <h2 class="text-xl font-bold text-emerald-600 mb-3">Rules & Regulations</h2>
      <ul class="list-disc pl-5 text-sm space-y-2">
        <li>No tab switching</li>
        <li>No exiting fullscreen</li>
        <li>No screenshots or copy</li>
        <li>Violations end the test</li>
        <li class="font-bold text-red-600">You can only submit when timer ends</li>
        <li class="font-bold text-red-600">Cannot retake completed patterns</li>
      </ul>
      <button onclick="startExam()" class="mt-4 w-full bg-emerald-600 text-white p-2 rounded">
        I Agree & Start Exam
      </button>
    </div>

    <div id="exam" class="hidden">
      <div class="mb-4 p-2 bg-blue-50 border border-blue-200 rounded text-center">
        <p class="text-sm text-blue-700">
          <i data-lucide="info" class="inline w-4 h-4 mr-1"></i>
          You can answer questions now, but can only submit when timer ends
        </p>
      </div>
      <div id="questionBox"></div>
      <button id="nextButton" onclick="nextQuestion()" class="mt-4 w-full bg-emerald-600 text-white p-2 rounded">
        Next
      </button>
    </div>

    <div id="waitingForTimer" class="hidden text-center">
      <div class="mb-6">
        <i data-lucide="clock" class="w-16 h-16 mx-auto text-yellow-500"></i>
      </div>
      <h2 class="text-2xl font-bold text-yellow-600 mb-4">Waiting for Timer</h2>
      <p class="text-gray-600 mb-4">Your exam has been submitted, but you must wait for the timer to end to get results.</p>
      <p class="text-sm text-gray-500 mb-6">Do not close or switch tabs during this time, or your test will be marked as failed.</p>
      <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
        <p class="font-semibold text-yellow-700">Time Remaining:</p>
        <div id="waitingTimer" class="text-3xl font-bold text-yellow-800 font-mono my-2">00:00</div>
        <p class="text-xs text-yellow-600">Results will be available after timer ends</p>
      </div>
      <p id="waitingStatus" class="text-sm text-gray-500"></p>
    </div>

    <div id="failed" class="hidden text-center">
      <div class="mb-6">
        <i data-lucide="x-circle" class="w-16 h-16 mx-auto text-red-500"></i>
      </div>
      <h2 class="text-2xl font-bold text-red-600">Test Failed</h2>
      <p class="text-sm text-gray-600 mb-2">Malpractice detected or window focus lost.</p>
      <div class="relative">
      <input
        id="secondPass"
        type="password"
        autocomplete="new-password"
        class="w-full p-2 mt-3 border rounded"
        placeholder="Second Chance Code"
      />
      </div>
      <button onclick="secondChance()" class="mt-3 w-full bg-emerald-600 text-white p-2 rounded">
        Retry Exam
      </button>
      <div id="retryMsg" class="text-red-500 text-xs mt-2"></div>
      <button onclick="resetToLogin()" class="mt-4 w-full bg-gray-600 text-white p-2 rounded text-sm">
        Back to Login
      </button>
    </div>

    <div id="result" class="hidden text-center">
      <div class="mb-6">
        <i data-lucide="trophy" class="w-16 h-16 mx-auto text-emerald-500"></i>
      </div>
      <h2 class="text-2xl font-bold text-emerald-600">Test Completed Successfully!</h2>
      <p id="resultText" class="mt-3 text-lg font-semibold"></p>
      <div class="mt-6 p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
        <p class="text-sm text-emerald-700 mb-2">Pattern Completed: <span class="font-bold" id="completedPatternDisplay"></span></p>
        <p class="text-xs text-emerald-600">You cannot retake this pattern</p>
      </div>
      <div class="mt-6 space-y-3">
        <button onclick="downloadPDF()" class="w-full bg-emerald-600 text-white p-2 rounded font-semibold">
          <i data-lucide="download" class="inline w-4 h-4 mr-2"></i> Download PDF Certificate
        </button>
        <button onclick="resetToLogin()" class="w-full bg-blue-600 text-white p-2 rounded">
          <i data-lucide="rotate-ccw" class="inline w-4 h-4 mr-2"></i> Take Another Test (Different Pattern)
        </button>
        <button onclick="showSection('home')" class="w-full bg-gray-600 text-white p-2 rounded">
          <i data-lucide="home" class="inline w-4 h-4 mr-2"></i> Return to Home
        </button>
      </div>
    </div>

  </div>
</section>

<!-- HANGMAN Game -->
<section id="hangman" class="hidden py-16">
  <div class="max-w-4xl mx-auto px-4">
    <h2 class="text-3xl font-bold text-center text-emerald-600 mb-8">Tech Hangman</h2>
    <div class="flex justify-center"><p class="text-gray-500">(Game functionality preserved)</p></div>
    <div class="bg-white p-6 rounded-xl shadow-lg border mt-4 text-center">
        <div id="hangmanWordDisplay" class="text-2xl font-mono mb-4"></div>
        <div id="letterButtons" class="flex flex-wrap gap-2 justify-center"></div>
        <button onclick="initializeHangman()" class="mt-4 bg-emerald-600 text-white px-4 py-2 rounded">Start Game</button>
    </div>
  </div>
</section>

<section id="admin" class="hidden py-16">
  <div class="max-w-6xl mx-auto px-4">
    <h2 class="text-3xl font-bold text-center text-emerald-600 mb-8">Admin Dashboard</h2>
    
    <div id="adminLogin" class="bg-white p-6 rounded-xl shadow-lg border max-w-md mx-auto">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Admin Authentication</h3>
      <input id="adminName" class="w-full p-2 mb-3 border rounded" placeholder="Admin Name" value="Ellen@SRCAS">
      <input id="adminPassword" type="password" class="w-full p-2 mb-4 border rounded" placeholder="Password" value="srcasadmin123">
      <button onclick="adminLogin()" class="w-full bg-emerald-600 text-white p-2 rounded font-semibold">
        Login as Admin
      </button>
    </div>

    <div id="adminDashboard" class="hidden bg-white p-6 rounded-xl shadow-lg border mt-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Exam Control Panel</h3>
        <button onclick="adminLogout()" class="text-sm text-red-600 hover:text-red-800">
          <i data-lucide="log-out" class="inline w-4 h-4 mr-1"></i> Logout
        </button>
      </div>

      <!-- Timer Control-->
      <div class="mb-8 p-4 bg-gray-50 rounded-lg">
        <h4 class="font-bold text-lg text-gray-700 mb-3 flex items-center gap-2">
          <i data-lucide="clock"></i> Exam Window Control
        </h4>
        
        <!-- Timer Status -->
        <div id="timerStatus" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
          <div class="flex items-center justify-between">
            <div>
              <span class="font-semibold text-blue-700">Status:</span>
              <span id="currentTimerStatus" class="ml-2 px-2 py-1 rounded text-sm font-medium bg-gray-100">Not Active</span>
            </div>
            <div id="activeTimerInfo" class="hidden">
              <span class="font-semibold text-blue-700">Remaining:</span>
              <span id="activeTimerRemaining" class="ml-2 font-mono text-lg font-bold">00:00</span>
            </div>
          </div>
          <div id="timerDetails" class="mt-2 text-sm text-gray-600">
            
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Start In (Minutes)</label>
            <input id="startInMinutes" type="number" min="0" max="60" value="0" class="w-full p-2 border rounded">
            <p class="text-xs text-gray-500 mt-1">0 = start immediately</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Duration (Minutes)</label>
            <input id="durationMinutes" type="number" min="1" max="120" value="30" class="w-full p-2 border rounded">
            <p class="text-xs text-gray-500 mt-1">Exam window duration</p>
          </div>
        </div>

        <button onclick="setExamWindow()" class="w-full mb-4 bg-emerald-600 text-white p-2 rounded font-semibold">
          Set Exam Window
        </button>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
          <button onclick="quickSetTimer(5)" class="bg-blue-100 text-blue-700 p-2 rounded hover:bg-blue-200">
            5 min
          </button>
          <button onclick="quickSetTimer(10)" class="bg-blue-100 text-blue-700 p-2 rounded hover:bg-blue-200">
            10 min
          </button>
          <button onclick="quickSetTimer(20)" class="bg-blue-100 text-blue-700 p-2 rounded hover:bg-blue-200">
            20 min
          </button>
          <button onclick="quickSetTimer(30)" class="bg-blue-100 text-blue-700 p-2 rounded hover:bg-blue-200">
            30 min
          </button>
        </div>

        <div class="flex gap-2">
          <button onclick="pauseGlobalTimer()" class="flex-1 bg-yellow-500 text-white p-2 rounded">
            <i data-lucide="pause" class="inline w-4 h-4 mr-1"></i> Pause
          </button>
          <button onclick="resumeGlobalTimer()" class="flex-1 bg-blue-500 text-white p-2 rounded">
            <i data-lucide="play" class="inline w-4 h-4 mr-1"></i> Resume
          </button>
          <button onclick="stopGlobalTimer()" class="flex-1 bg-red-600 text-white p-2 rounded">
            <i data-lucide="square" class="inline w-4 h-4 mr-1"></i> Stop
          </button>
        </div>

     
        <div class="mt-6">
          <h5 class="font-bold text-gray-700 mb-2 flex items-center gap-2">
            <i data-lucide="history"></i> Timer History
          </h5>
          <div id="timerHistory" class="text-sm text-gray-600">
            <p class="text-gray-400 italic">No timer history yet</p>
          </div>
        </div>
      </div>

     
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-emerald-600">Total Students</p>
              <p id="totalStudents" class="text-2xl font-bold text-emerald-700">0</p>
            </div>
            <i data-lucide="users" class="text-emerald-500"></i>
          </div>
        </div>
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-blue-600">Active Exams</p>
              <p id="activeExams" class="text-2xl font-bold text-blue-700">0</p>
            </div>
            <i data-lucide="activity" class="text-blue-500"></i>
          </div>
        </div>
        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-purple-600">Completed</p>
              <p id="completedExams" class="text-2xl font-bold text-purple-700">0</p>
            </div>
            <i data-lucide="check-circle" class="text-purple-500"></i>
          </div>
        </div>
        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-yellow-600">Waiting</p>
              <p id="waitingExams" class="text-2xl font-bold text-yellow-700">0</p>
            </div>
            <i data-lucide="clock" class="text-yellow-500"></i>
          </div>
        </div>
      </div>

      <!-- Student Management -->
      <div class="mb-6">
        <h4 class="font-bold text-lg text-gray-700 mb-3">Student Management</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Student Name</label>
            <input id="studentNameInput" class="w-full p-2 border rounded" placeholder="Enter student name">
          </div>
          <div class="flex items-end gap-2">
            <button onclick="clearStudentCompleted()" class="flex-1 bg-red-100 text-red-700 p-2 rounded hover:bg-red-200">
              Clear Completed
            </button>
            <button onclick="endStudentExam()" class="flex-1 bg-red-600 text-white p-2 rounded hover:bg-red-700">
              End Exam
            </button>
          </div>
        </div>
      </div>

      <!-- Student List -->
      <div>
        <h4 class="font-bold text-lg text-gray-700 mb-3">Active Students</h4>
        <div id="studentList" class="border rounded-lg overflow-hidden">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 text-left">Name</th>
                <th class="p-3 text-left">Pattern</th>
                <th class="p-3 text-left">Status</th>
                <th class="p-3 text-left">Progress</th>
                <th class="p-3 text-left">Completed Patterns</th>
                <th class="p-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="studentTableBody" class="divide-y">
              
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>


<section id="about" class="hidden py-20">
    <div class="text-center text-gray-600">
        <h2 class="text-3xl font-bold text-emerald-600">About</h2>
        <p class="mt-4">Xamplore - Strict Timing Exam Platform.</p>
        <p class="text-sm text-gray-500 mt-2">Version 3.0 - Prevents cheating with strict timing controls</p>
    </div>
</section>

<script>
lucide.createIcons();

// Elements load using Tailwind
const el = id => document.getElementById(id);

// State
let questions = []; 
let currentIndex = 0;
let userAnswers = []; 
let finalResults = null; 
let studentName = "";
let studentPattern = "";
let adminAuthenticated = false;
let adminPollingInterval = null;
let studentTimerInterval = null;
let examWindowInterval = null;
let lastTimerState = { active: false };
let isWaitingForTimer = false; 
let examSubmitted = false; 
let completedPatterns = []; 

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => el('welcomePopup').classList.remove('hidden'), 500);
  checkAuth();
});
function closeWelcomePopup() { el('welcomePopup').classList.add('hidden'); }

function toggleMenu(){ el('mobileMenu').classList.toggle("hidden"); }
function showSection(id){
  ["home","test","hangman","admin","about"].forEach(s => el(s).classList.add("hidden"));
  el(id).classList.remove("hidden");
  el('mobileMenu').classList.add("hidden");
  if(id === 'hangman') initializeHangman();
  if(id === 'admin' && adminAuthenticated) {
    loadAdminDashboard();
    startAdminPolling();
  } else if(id !== 'admin' && adminAuthenticated) {
    if (adminPollingInterval) {
      clearInterval(adminPollingInterval);
      adminPollingInterval = null;
    }
  }
  if(id === 'test') {
    checkCompletedPatterns();
    checkExamWindowStatus();
    if (!examWindowInterval) {
      examWindowInterval = setInterval(checkExamWindowStatus, 1000);
    }
  }
}

// Reset to Login
function resetToLogin() {
 
  el('login').classList.remove('hidden');
  el('rules').classList.add('hidden');
  el('exam').classList.add('hidden');
  el('waitingForTimer').classList.add('hidden');
  el('failed').classList.add('hidden');
  el('result').classList.add('hidden');
  el('loader').classList.add('hidden');
  el('globalTimerDisplay').classList.add('hidden');
  el('examWindowStatus').classList.add('hidden');
  

  el('nameInput').value = '';
  el('patternSelect').value = '';
  el('passwordInput').value = '';
  el('patternWarning').classList.add('hidden');

  questions = [];
  currentIndex = 0;
  userAnswers = [];
  finalResults = null;
  isWaitingForTimer = false;
  examSubmitted = false;
  
  if (studentTimerInterval) {
    clearInterval(studentTimerInterval);
    studentTimerInterval = null;
  }
  
  checkCompletedPatterns();
  checkExamWindowStatus();
}

// EXAM WINDOW FUNCTIONS

async function checkExamWindowStatus() {
  try {
    const res = await fetch('/api/timer/status');
    if (res.ok) {
      const timerStatus = await res.json();
      updateExamWindowDisplay(timerStatus);
    }
  } catch (e) {
    console.error("Error checking exam window:", e);
  }
}

function updateExamWindowDisplay(timerStatus) {
  const display = el('examWindowStatus');
  const content = el('examWindowContent');
  const globalDisplay = el('globalTimerDisplay');
  const globalTimer = el('globalTimer');
  const timerMessage = el('timerMessage');
  
  if (timerStatus.active) {
    display.classList.remove('hidden');
    globalDisplay.classList.remove('hidden');
    
    if (timerStatus.paused) {
      content.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-yellow-600">
          <i data-lucide="pause" class="w-4 h-4"></i>
          <span class="font-medium">Exam Window Paused</span>
        </div>
      `;
      display.className = 'mb-4 p-3 border rounded-lg text-center exam-waiting';
      
      globalTimer.textContent = "PAUSED";
      timerMessage.textContent = "Exam window is paused";
      
    } else if (timerStatus.startTime && Date.now() < timerStatus.startTime) {
      const timeLeft = timerStatus.startTime - Date.now();
      const minutes = Math.floor(timeLeft / 60000);
      const seconds = Math.floor((timeLeft % 60000) / 1000);
      
      content.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-yellow-600">
          <i data-lucide="clock" class="w-4 h-4"></i>
          <span class="font-medium">Exam starts in ${minutes}m ${seconds}s</span>
        </div>
      `;
      display.className = 'mb-4 p-3 border rounded-lg text-center exam-waiting';
      
      globalTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      timerMessage.textContent = "Waiting for exam to start";
      
    } else if (timerStatus.endTime && Date.now() > timerStatus.endTime) {
      content.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-red-600">
          <i data-lucide="x-circle" class="w-4 h-4"></i>
          <span class="font-medium">Exam Window Closed</span>
        </div>
        <p class="text-xs text-gray-500 mt-1">You can submit if you completed the exam</p>
      `;
      display.className = 'mb-4 p-3 border rounded-lg text-center exam-closed';
      
      globalTimer.textContent = "ENDED";
      timerMessage.textContent = "Exam window has closed";
      
    } else {
      const timeLeft = timerStatus.endTime - Date.now();
      const minutes = Math.floor(timeLeft / 60000);
      const seconds = Math.floor((timeLeft % 60000) / 1000);
      
      content.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-green-600">
          <i data-lucide="check-circle" class="w-4 h-4"></i>
          <span class="font-medium">Exam Window Open</span>
        </div>
        <p class="text-xs text-gray-500 mt-1">Ends in ${minutes}m ${seconds}s</p>
      `;
      display.className = 'mb-4 p-3 border rounded-lg text-center exam-open';
      
      globalTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      timerMessage.textContent = "Exam window is open - you can start exams";
      
     
      globalDisplay.classList.add('timer-running');
    }
  } else {
    display.classList.add('hidden');
    globalDisplay.classList.add('hidden');
  }
}

// ADMIN FUNCTIONS

async function adminLogin() {
  const name = el('adminName').value.trim();
  const password = el('adminPassword').value;

  if (name !== "Ellen@SRCAS" || password !== "srcasadmin123") {
    alert("Invalid admin credentials");
    return;
  }

  try {
    const res = await fetch('/api/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, password })
    });
    
    const data = await res.json();
    if (res.ok) {
      adminAuthenticated = true;
      el('adminLogin').classList.add('hidden');
      el('adminDashboard').classList.remove('hidden');
      loadAdminDashboard();
      startAdminPolling();
    } else {
      alert(data.error || "Admin login failed");
    }
  } catch (e) {
    alert("Server error during admin login");
  }
}

function adminLogout() {
  adminAuthenticated = false;
  el('adminLogin').classList.remove('hidden');
  el('adminDashboard').classList.add('hidden');
  if (adminPollingInterval) {
    clearInterval(adminPollingInterval);
    adminPollingInterval = null;
  }
}

async function loadAdminDashboard() {
  if (!adminAuthenticated) return;
  
  try {
    const [statsRes, timerRes, studentsRes] = await Promise.all([
      fetch('/api/admin/stats'),
      fetch('/api/admin/timer'),
      fetch('/api/admin/students')
    ]);
    
    const stats = await statsRes.json();
    const timer = await timerRes.json();
    const students = await studentsRes.json();
    
    el('totalStudents').textContent = stats.totalStudents || 0;
    el('activeExams').textContent = stats.activeExams || 0;
    el('completedExams').textContent = stats.completedExams || 0;
    el('waitingExams').textContent = stats.waitingExams || 0;
    
    updateTimerDisplay(timer);
    updateStudentList(students);
    
  } catch (e) {
    console.error("Error loading admin dashboard:", e);
  }
}

function updateTimerDisplay(timer) {
  const statusEl = el('currentTimerStatus');
  const activeInfoEl = el('activeTimerInfo');
  const remainingEl = el('activeTimerRemaining');
  const detailsEl = el('timerDetails');
  
  if (timer.active) {
    statusEl.textContent = timer.paused ? 'Paused' : 'Running';
    statusEl.className = 'ml-2 px-2 py-1 rounded text-sm font-medium ' + 
      (timer.paused ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
    
    activeInfoEl.classList.remove('hidden');
    
    const now = Date.now();
    let remainingMs = 0;
    
    if (timer.paused) {
      remainingMs = timer.pauseRemaining;
      detailsEl.innerHTML = `<span class="text-yellow-600">Timer paused</span>`;
    } else if (timer.endTime) {
      remainingMs = timer.endTime - now;
      
      if (timer.startTime && now < timer.startTime) {
        const startIn = timer.startTime - now;
        const startMinutes = Math.floor(startIn / 60000);
        const startSeconds = Math.floor((startIn % 60000) / 1000);
        detailsEl.innerHTML = `
          <div>Starts in: ${startMinutes}m ${startSeconds}s</div>
          <div>Duration: ${Math.floor(timer.duration / 60)}m ${timer.duration % 60}s</div>
        `;
      } else if (timer.endTime > now) {
        const totalDuration = timer.endTime - (timer.startTime || now);
        const elapsed = now - (timer.startTime || now);
        const progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
        
        detailsEl.innerHTML = `
          <div>Progress: <span class="font-medium">${Math.round(progress)}%</span></div>
          <div>Ends in: ${Math.floor(remainingMs / 60000)}m ${Math.floor((remainingMs % 60000) / 1000)}s</div>
        `;
      } else {
        detailsEl.innerHTML = `<span class="text-red-600">Exam window closed</span>`;
      }
    }
    
    if (remainingMs > 0) {
      const minutes = Math.floor(remainingMs / 60000);
      const seconds = Math.floor((remainingMs % 60000) / 1000);
      remainingEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
      remainingEl.textContent = '00:00';
      if (!timer.paused && timer.endTime && timer.endTime <= now) {
        statusEl.textContent = 'Expired';
        statusEl.className = 'ml-2 px-2 py-1 rounded text-sm font-medium bg-red-100 text-red-800';
      }
    }
  } else {
    statusEl.textContent = 'Not Active';
    statusEl.className = 'ml-2 px-2 py-1 rounded text-sm font-medium bg-gray-100 text-gray-800';
    activeInfoEl.classList.add('hidden');
    remainingEl.textContent = '00:00';
    detailsEl.innerHTML = '<span class="text-gray-500">No exam window set</span>';
  }
}

function updateStudentList(students) {
  const tbody = el('studentTableBody');
  if (!students || students.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No active students</td></tr>';
    return;
  }
  
  tbody.innerHTML = students.map(student => `
    <tr class="hover:bg-gray-50">
      <td class="p-3 font-medium">${student.name}</td>
      <td class="p-3">Pattern ${student.pattern}</td>
      <td class="p-3">
        <span class="px-2 py-1 rounded text-xs font-medium ${
          student.status === 'started' ? 'bg-blue-100 text-blue-800' :
          student.status === 'completed' ? 'bg-green-100 text-green-800' :
          student.status === 'failed' ? 'bg-red-100 text-red-800' :
          student.status === 'waiting' ? 'bg-yellow-100 text-yellow-800' :
          'bg-gray-100 text-gray-800'
        }">
          ${student.status}
        </span>
      </td>
      <td class="p-3">
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-emerald-600 h-2 rounded-full" style="width: ${student.progress || 0}%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1">${student.currentQuestion || 0}/${student.totalQuestions || 0}</div>
      </td>
      <td class="p-3">
        ${student.completedPatterns && student.completedPatterns.length > 0 ? 
          student.completedPatterns.map(p => 
            `<span class="inline-block px-2 py-1 mr-1 mb-1 text-xs bg-emerald-100 text-emerald-800 rounded">${p}</span>`
          ).join('') : 
          '<span class="text-gray-400 text-xs">None</span>'
        }
      </td>
      <td class="p-3">
        <div class="flex flex-col gap-1">
          <button onclick="adminEndSpecificExam('${student.name}')" class="text-xs text-red-600 hover:text-red-800">
            <i data-lucide="x-circle" class="inline w-3 h-3 mr-1"></i> End Exam
          </button>
          <button onclick="adminClearStudentCompleted('${student.name}')" class="text-xs text-blue-600 hover:text-blue-800">
            <i data-lucide="refresh-cw" class="inline w-3 h-3 mr-1"></i> Clear Completed
          </button>
        </div>
      </td>
    </tr>
  `).join('');
  
  lucide.createIcons();
}

async function setExamWindow() {
  const startInMinutes = parseInt(el('startInMinutes').value) || 0;
  const durationMinutes = parseInt(el('durationMinutes').value) || 30;
  
  if (durationMinutes <= 0) {
    alert("Please set a valid duration");
    return;
  }
  
  try {
    const res = await fetch('/api/admin/timer/set', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ startInMinutes, durationMinutes })
    });
    
    const data = await res.json();
    if (res.ok) {
      alert(`Exam window set! ${data.message}`);
      loadAdminDashboard();
    } else {
      alert(data.error || "Failed to set timer");
    }
  } catch (e) {
    alert("Error setting exam window");
  }
}

function quickSetTimer(minutes) {
  el('startInMinutes').value = 0;
  el('durationMinutes').value = minutes;
  setExamWindow();
}

async function startGlobalTimer() {
  const duration = parseInt(el('durationMinutes').value) || 30;
  const totalSeconds = duration * 60;
  
  try {
    const res = await fetch('/api/admin/timer/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ duration: totalSeconds })
    });
    
    const data = await res.json();
    if (res.ok) {
      alert("Timer started!");
      loadAdminDashboard();
    } else {
      alert(data.error || "Failed to start timer");
    }
  } catch (e) {
    alert("Error starting timer");
  }
}

async function pauseGlobalTimer() {
  try {
    const res = await fetch('/api/admin/timer/pause', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      loadAdminDashboard();
    } else {
      alert(data.error || "Failed to pause timer");
    }
  } catch (e) {
    alert("Error pausing timer");
  }
}

async function resumeGlobalTimer() {
  try {
    const res = await fetch('/api/admin/timer/resume', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      loadAdminDashboard();
    } else {
      alert(data.error || "Failed to resume timer");
    }
  } catch (e) {
    alert("Error resuming timer");
  }
}

async function stopGlobalTimer() {
  try {
    const res = await fetch('/api/admin/timer/stop', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      alert("Timer stopped!");
      loadAdminDashboard();
    } else {
      alert(data.error || "Failed to stop timer");
    }
  } catch (e) {
    alert("Error stopping timer");
  }
}

async function adminEndSpecificExam(studentName) {
  if (!confirm(`Are you sure you want to end the exam for ${studentName}?`)) return;
  
  try {
    const res = await fetch('/api/admin/end-exam', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ studentName })
    });
    
    const data = await res.json();
    if (res.ok) {
      alert(`Exam ended for ${studentName}`);
      loadAdminDashboard();
    } else {
      alert(data.error || "Failed to end exam");
    }
  } catch (e) {
    alert("Error ending exam");
  }
}

async function adminClearStudentCompleted(studentName) {
  if (!confirm(`Clear completed patterns for ${studentName}? This will allow them to retake tests.`)) return;
  
  try {
    const res = await fetch('/api/admin/clear-completed', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ studentName })
    });
    
    const data = await res.json();
    if (res.ok) {
      alert(`Cleared completed patterns for ${studentName}`);
      loadAdminDashboard();
    } else {
      alert(data.error || "Failed to clear completed patterns");
    }
  } catch (e) {
    alert("Error clearing completed patterns");
  }
}

async function endStudentExam() {
  const studentName = el('studentNameInput').value.trim();
  if (!studentName) {
    alert("Please enter a student name");
    return;
  }
  
  await adminEndSpecificExam(studentName);
  el('studentNameInput').value = '';
}

async function clearStudentCompleted() {
  const studentName = el('studentNameInput').value.trim();
  if (!studentName) {
    alert("Please enter a student name");
    return;
  }
  
  await adminClearStudentCompleted(studentName);
  el('studentNameInput').value = '';
}

function startAdminPolling() {
  if (adminPollingInterval) clearInterval(adminPollingInterval);
  adminPollingInterval = setInterval(loadAdminDashboard, 3000);
}

//BACKEND API INTERACTION

async function checkAuth() {
    try {
        const res = await fetch('/api/me');
        const data = await res.json();
        
        if (data.loggedIn) {
            studentName = data.name;
            studentPattern = data.pattern;
            
            if (data.status === 'completed') {
                showResultScreen(data.score, data.totalQuestions, true);
            } else if (data.status === 'started') {
                 el('login').classList.add('hidden');
                 el('rules').classList.remove('hidden');
            } else if (data.status === 'failed') {
                 failTestUI();
            } else if (data.status === 'waiting') {
                 showWaitingForTimer();
            }
            
           
            if (data.completedPatterns) {
                completedPatterns = data.completedPatterns;
                updateCompletedPatternsUI();
            }
        }
    } catch (e) { console.error("Auth check failed", e); }
}

async function checkCompletedPatterns() {
  try {
    const res = await fetch('/api/completed-patterns');
    const data = await res.json();
    
    if (res.ok && data.completedPatterns) {
      completedPatterns = data.completedPatterns;
      updateCompletedPatternsUI();
    }
  } catch (e) {
    console.error("Error checking completed patterns:", e);
  }
}

function updateCompletedPatternsUI() {
  const warning = el('completedPatternsWarning');
  const list = el('completedPatternsList');
  const patternSelect = el('patternSelect');
  
  if (completedPatterns.length > 0) {
    warning.classList.remove('hidden');
    
   
    list.innerHTML = completedPatterns.map(pattern => 
      `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
        <i data-lucide="x" class="w-3 h-3 mr-1"></i> Pattern ${pattern}
      </span>`
    ).join('');
    
 
    Array.from(patternSelect.options).forEach(option => {
      if (option.value && completedPatterns.includes(option.value)) {
        option.disabled = true;
        option.textContent = `Pattern ${option.value} (Completed)`;
        option.classList.add('text-gray-400');
      }
    });
    
    lucide.createIcons();
  } else {
    warning.classList.add('hidden');
  }
}

async function verifyLogin() {
    const name = el('nameInput').value.trim();
    const pattern = el('patternSelect').value;
    const password = el('passwordInput').value;
    const patternWarning = el('patternWarning');

    if (!name || !pattern || !password) {
        patternWarning.textContent = "Please fill all fields";
        patternWarning.classList.remove('hidden');
        return;
    }
    
    
    if (completedPatterns.includes(pattern)) {
        patternWarning.textContent = `Pattern ${pattern} is already completed. You cannot retake it.`;
        patternWarning.classList.remove('hidden');
        return;
    }
    
    patternWarning.classList.add('hidden');
    el('loader').classList.remove('hidden');
    el('login').classList.add('hidden');

    try {
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, pattern, password })
        });
        
        const data = await res.json();
        el('loader').classList.add('hidden');

        if (res.ok) {
            studentName = name;
            studentPattern = pattern;
            el('rules').classList.remove('hidden');
        } else {
            patternWarning.textContent = data.error || "Login Failed";
            patternWarning.classList.remove('hidden');
            el('login').classList.remove('hidden');
        }
    } catch (e) {
        el('loader').classList.add('hidden');
        el('login').classList.remove('hidden');
        patternWarning.textContent = "Server Error";
        patternWarning.classList.remove('hidden');
    }
}

async function startExam() {
    try {
        const res = await fetch('/api/start-v2', { method: 'POST' });
        const data = await res.json();
        
        if (res.ok) {
            questions = data.questions;
            currentIndex = 0;
            userAnswers = [];
            
            el('rules').classList.add('hidden');
            el('exam').classList.remove('hidden');
            
            try { document.documentElement.requestFullscreen(); } catch(e){}
            
            renderQuestion();
            startMonitoring();
            
            if (studentTimerInterval) clearInterval(studentTimerInterval);
            studentTimerInterval = setInterval(checkExamWindowStatus, 1000);
            checkExamWindowStatus();
        } else {
            alert(data.error);
            if (data.error.includes("failed")) failTestUI();
            if (data.error.includes("waiting")) {
                showWaitingForTimer();
            }
            if (data.error.includes("completed")) {
                checkCompletedPatterns();
                resetToLogin();
            }
        }
    } catch (e) { alert("Could not start exam"); }
}

function renderQuestion() {
    const q = questions[currentIndex];
    const isLastQuestion = currentIndex >= questions.length - 1;
    
    el('questionBox').innerHTML = `
        <p class="font-semibold mb-3">Q${currentIndex+1}: ${q.q}</p>
        ${q.options.map(o => `
            <label class="block mb-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                <input type="radio" name="ans" value="${o}" class="mr-2"> ${o}
            </label>
        `).join("")}
    `;
    
    const nextButton = el('nextButton');
    if (isLastQuestion) {
        nextButton.textContent = 'Submit Exam';
        nextButton.classList.remove('bg-emerald-600');
        nextButton.classList.add('bg-purple-600');
        nextButton.onclick = handleLastQuestion;
    } else {
        nextButton.textContent = 'Next';
        nextButton.classList.remove('bg-purple-600');
        nextButton.classList.add('bg-emerald-600');
        nextButton.onclick = nextQuestion;
    }
}

async function handleLastQuestion() {
    const sel = document.querySelector("input[name='ans']:checked");
    if (!sel) return alert("Please select an option");
    
    userAnswers.push(sel.value);
    
    const canSubmit = await checkIfCanSubmit();
    
    if (!canSubmit.canSubmit) {
        alert(`Cannot submit yet. ${canSubmit.message}`);
        userAnswers.pop(); // Remove the last answer
        return;
    }
    
    submitExam();
}

async function nextQuestion() {
    const sel = document.querySelector("input[name='ans']:checked");
    if (!sel) return alert("Please select an option");
    
    userAnswers.push(sel.value);
    currentIndex++;
    
    if (currentIndex >= questions.length) {
       
        const canSubmit = await checkIfCanSubmit();
        
        if (!canSubmit.canSubmit) {
            alert(`Cannot submit yet. ${canSubmit.message}`);
            currentIndex--; // Go back to last question
            userAnswers.pop(); // Remove the last answer
            renderQuestion();
            return;
        }
        
        submitExam();
    } else {
        renderQuestion();
    }
}

async function checkIfCanSubmit() {
    try {
        const res = await fetch('/api/timer/can-submit');
        const data = await res.json();
        return data;
    } catch (e) {
        return { canSubmit: true, message: "Error checking submit status" };
    }
}

async function submitExam() {
    el('loader').classList.remove('hidden');
    el('exam').classList.add('hidden');
    
    try {
        const res = await fetch('/api/submit-v2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answers: userAnswers })
        });
        
        const data = await res.json();
        el('loader').classList.add('hidden');
        
        if (res.ok) {
            examSubmitted = true;
            
            if (data.waiting) {
                // Timer is still active, go to waiting mode
                showWaitingForTimer();
            } else {
                // Timer ended or not active, show results immediately
                finalResults = data.results;
                showResultScreen(data.score, data.total);
                stopMonitoring();
                
                // Update completed patterns
                if (!completedPatterns.includes(studentPattern)) {
                    completedPatterns.push(studentPattern);
                    updateCompletedPatternsUI();
                }
                
                if (studentTimerInterval) {
                    clearInterval(studentTimerInterval);
                    studentTimerInterval = null;
                }
            }
        } else {
            alert("Submission failed: " + data.error);
        }
    } catch (e) { 
        alert("Error submitting");
        console.error(e);
    }
}

function showWaitingForTimer() {
  el('login').classList.add('hidden');
  el('rules').classList.add('hidden');
  el('exam').classList.add('hidden');
  el('failed').classList.add('hidden');
  el('result').classList.add('hidden');
  el('waitingForTimer').classList.remove('hidden');
  
  isWaitingForTimer = true;
  examSubmitted = true;
  
  // Start monitoring for waiting period too
  startMonitoring();
  
  if (studentTimerInterval) clearInterval(studentTimerInterval);
  studentTimerInterval = setInterval(checkWaitingTimer, 1000);
  checkWaitingTimer();
}

async function checkWaitingTimer() {
  try {
    const res = await fetch('/api/check-results');
    const data = await res.json();
    
    if (res.ok && data.completed) {
      
      finalResults = data.results;
      showResultScreen(data.score, data.total);
      stopMonitoring();
      isWaitingForTimer = false;
      
      if (!completedPatterns.includes(studentPattern)) {
        completedPatterns.push(studentPattern);
        updateCompletedPatternsUI();
      }
      
      if (studentTimerInterval) {
        clearInterval(studentTimerInterval);
        studentTimerInterval = null;
      }
    } else if (res.ok && !data.completed) {
   
      if (data.remaining) {
        const minutes = Math.floor(data.remaining / 60000);
        const seconds = Math.floor((data.remaining % 60000) / 1000);
        el('waitingTimer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
      el('waitingStatus').textContent = data.message || "Waiting for timer to end...";
    }
  } catch (e) {
    console.error("Error checking waiting timer:", e);
  }
}

function showResultScreen(score, total, minimal = false) {
    el('login').classList.add('hidden');
    el('rules').classList.add('hidden');
    el('exam').classList.add('hidden');
    el('waitingForTimer').classList.add('hidden');
    el('failed').classList.add('hidden');
    el('result').classList.remove('hidden');
    el('globalTimerDisplay').classList.add('hidden');
    el('examWindowStatus').classList.add('hidden');
    
    try { document.exitFullscreen(); } catch(e){}
    
    el('resultText').textContent = `${studentName} — Pattern ${studentPattern} — Score ${score}/${total}`;
    el('completedPatternDisplay').textContent = studentPattern;
    
    if (minimal) {
        if (!finalResults) document.querySelector("#result button").style.display = 'none';
        el('resultText').innerHTML += "<br><span class='text-xs text-gray-500'>(Reloaded - PDF unavailable)</span>";
    }
}

let monitoringActive = false;

function startMonitoring() {
    monitoringActive = true;
    document.addEventListener("visibilitychange", handleVisibilityChange);
    window.addEventListener("blur", handleBlur);
    document.addEventListener("fullscreenchange", handleFullscreen);
    window.addEventListener("beforeunload", handleBeforeUnload);
}

function stopMonitoring() {
    monitoringActive = false;
    document.removeEventListener("visibilitychange", handleVisibilityChange);
    window.removeEventListener("blur", handleBlur);
    document.removeEventListener("fullscreenchange", handleFullscreen);
    window.removeEventListener("beforeunload", handleBeforeUnload);
}

function handleVisibilityChange() {
    if (monitoringActive && document.hidden) triggerFail("Tab switch detected");
}
function handleBlur() {
    if (monitoringActive) triggerFail("Window focus lost");
}
function handleFullscreen() {
    if (monitoringActive && !document.fullscreenElement) triggerFail("Exited fullscreen");
}
function handleBeforeUnload(e) {
    if (monitoringActive) {
        
        triggerFail("Window closed");
        e.preventDefault();
        e.returnValue = '';
    }
}

function triggerFail(reason) {
    monitoringActive = false;
    
    if (examSubmitted && isWaitingForTimer) {
        fetch('/api/fail-waiting', { method: 'POST' });
    } else if (monitoringActive) {
        fetch('/api/fail', { method: 'POST' });
    }
    
    failTestUI();
}

function failTestUI() {
    el('exam').classList.add('hidden');
    el('rules').classList.add('hidden');
    el('login').classList.add('hidden');
    el('waitingForTimer').classList.add('hidden');
    el('result').classList.add('hidden');
    el('failed').classList.remove('hidden');
    el('globalTimerDisplay').classList.add('hidden');
    el('examWindowStatus').classList.add('hidden');
    
    try { document.exitFullscreen(); } catch(e){}
    
    if (studentTimerInterval) {
        clearInterval(studentTimerInterval);
        studentTimerInterval = null;
    }
    
    isWaitingForTimer = false;
    examSubmitted = false;
}

async function secondChance() {
    const code = el('secondPass').value;
    
    try {
        const res = await fetch('/api/retry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code })
        });
        
        const data = await res.json();
        if (res.ok) {
            el('failed').classList.add('hidden');
            el('rules').classList.remove('hidden');
        } else {
            el('retryMsg').textContent = "Invalid Code";
        }
    } catch (e) {
        alert("Error connecting");
    }
}


function downloadPDF() {
    if (!finalResults) return alert("Results data not available");
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 10;
    
    pdf.setFontSize(16);
    pdf.text(`Xamplore Exam Certificate`, 10, y); y+=8;
    pdf.setFontSize(12);
    pdf.text(`Student: ${studentName}`, 10, y); y+=6;
    pdf.text(`Pattern: ${studentPattern}`, 10, y); y+=6;
    pdf.text(`Date: ${new Date().toLocaleDateString()}`, 10, y); y+=10;
    
    pdf.setFontSize(14);
    pdf.text(`Score: ${finalResults.filter(r => r.isCorrect).length}/${finalResults.length}`, 10, y); y+=10;
    
    pdf.setFontSize(12);
    pdf.text('Detailed Results:', 10, y); y+=8;
    
    finalResults.forEach((r, i) => {
        if (y > 270) { pdf.addPage(); y=10; }
        
        pdf.setFont(undefined, 'bold');
        pdf.text(`Q${i+1}: ${r.q.substring(0, 60)}${r.q.length > 60 ? '...' : ''}`, 10, y); y+=5;
        
        pdf.setFont(undefined, 'normal');
        pdf.setTextColor(r.isCorrect ? 0 : 200, r.isCorrect ? 100 : 0, 0);
        pdf.text(`Your Answer: ${r.userAns}`, 15, y); 
        
        if (!r.isCorrect) {
            pdf.setTextColor(0, 100, 0);
            pdf.text(`Correct: ${r.correctAns}`, 80, y);
        }
        y+=7;
        pdf.setTextColor(0);
    });
    
    pdf.save(`Xamplore_${studentName}_${studentPattern}.pdf`);
}

// --- HANGMAN ---
const HANGMAN_WORDS = ["javascript", "python", "react", "node", "vercel"];
let hangman = { word:"", guessed:[], lives:7 };
function initializeHangman() {
    hangman.word = HANGMAN_WORDS[Math.floor(Math.random()*5)];
    hangman.guessed = [];
    hangman.lives = 7;
    updateHangmanUI();
}
function updateHangmanUI() {
    const display = hangman.word.split('').map(l => hangman.guessed.includes(l)?l:'_').join(' ');
    el('hangmanWordDisplay').textContent = display;
    
    const alpha = 'abcdefghijklmnopqrstuvwxyz'.split('');
    el('letterButtons').innerHTML = alpha.map(l => `
        <button onclick="guess('${l}')" class="p-2 border rounded ${hangman.guessed.includes(l)?'bg-gray-200':''}" 
        ${hangman.guessed.includes(l)?'disabled':''}>${l}</button>
    `).join('');
}
window.guess = function(l) {
    hangman.guessed.push(l);
    updateHangmanUI();
}
</script>

</body>
</html>
